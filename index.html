<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧲⚡ Quy tắc bàn tay trái - Xác định lực từ</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };

        // TODO: Thay thế đoạn cấu hình dưới đây bằng cấu hình của bạn từ Firebase Console
		  // Import the functions you need from the SDKs you need
		  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
		  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
		  // TODO: Add SDKs for Firebase products that you want to use
		  // https://firebase.google.com/docs/web/setup#available-libraries

		  // Your web app's Firebase configuration
		  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
		  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
			const firebaseConfig = {
			  apiKey: "AIzaSyC0Tfjqv7EeHZD_uy9o0v5NiDDD47ak5k8",
			  authDomain: "physics-game-stats.firebaseapp.com",
			  projectId: "physics-game-stats",
			  storageBucket: "physics-game-stats.firebasestorage.app",
			  messagingSenderId: "58976681779",
			  appId: "1:58976681779:web:db8a6e48638cad275dc846",
			  measurementId: "G-1XDFVNXKHQ"
			};

		  // Initialize Firebase
		  const app = initializeApp(firebaseConfig);
		  const analytics = getAnalytics(app);
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: #fff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 100%;
            max-width: 400px;
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .login-box h1 {
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .login-box p {
            margin-bottom: 30px;
            color: #777;
        }
        
        .login-box input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .login-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.5);
        }
        
        .login-box button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }
        
        .login-box button:hover {
            background: #5a6acd;
            transform: translateY(-2px);
        }

        /* Game Styles */
        .game-container {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            max-width: 900px;
            margin: auto;
            min-height: 100vh;
            text-align: center;
        }

        .header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            color: #fff;
            font-size: 1.1em;
        }

        .header-left h2 {
            margin: 0;
            font-weight: normal;
        }

        .header-right {
            font-weight: bold;
        }

        .stats-button {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #fff;
            margin-right: 15px;
            transition: transform 0.2s;
        }

        .stats-button:hover {
            transform: scale(1.1);
        }

        .score-box {
            background: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: #333;
            font-weight: bold;
        }
        
        .timer-box {
            background: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: #333;
            font-weight: bold;
            margin-right: 10px;
        }

        .main-content {
            display: flex;
            flex-direction: row;
            width: 100%;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .problem-panel {
            flex: 2;
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .controls-panel {
            flex: 1;
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }

        #questionTitle {
            font-size: 1.5em;
            color: #4a4a4a;
            margin-bottom: 15px;
        }

        .math-container {
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        #canvas-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        canvas {
            width: 100%;
            height: 100%;
        }

        #mathOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .math-label {
            position: absolute;
            font-size: 1.2em;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 5px;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .answer-palette {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .answer-option {
            background: #f1f5f9;
            color: #4a5568;
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1 1 100px;
            text-align: center;
        }
        
        .answer-option:hover {
            border-color: #cbd5e0;
        }

        .answer-option.selected {
            background: #e2e8f0;
            border-color: #667eea;
            color: #4299e1;
        }
        
        .answer-option.correct-answer {
            background: #d1f7d1;
            border-color: #10b981;
            color: #10b981;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        
        .action-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }

        #checkBtn {
            background: #667eea;
            color: #fff;
        }

        #checkBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #nextBtn {
            background: #cbd5e0;
            color: #4a5568;
        }

        #finishBtn {
            width: 100%;
            margin-top: 10px;
            background: #dc2626;
            color: #fff;
        }

        #checkBtn:hover, #nextBtn:hover, #finishBtn:hover {
            transform: translateY(-2px);
        }
        
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            display: none;
        }

        .message.correct {
            background: #d1f7d1;
            color: #10b981;
        }

        .message.incorrect {
            background: #fce7e7;
            color: #dc2626;
        }

        /* Stats Panel */
        .stats-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 300px;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            padding: 20px;
            transform: translateX(-100%);
            transition: transform 0.4s ease-in-out;
            z-index: 100;
        }

        .stats-panel.hidden {
            transform: translateX(0%);
        }

        .stats-panel h3 {
            color: #764ba2;
            margin-bottom: 20px;
        }

        .stats-panel .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f1f5f9;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .stats-panel .stat-label {
            font-weight: bold;
            color: #4a5568;
        }

        .stats-panel .stat-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #667eea;
        }
        
        /* General Popups */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 200;
        }
        
        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .popup-content {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            width: 90%;
            max-width: 500px;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        
        .popup-overlay.show .popup-content {
            transform: scale(1);
        }

        .popup-content h2 {
            margin-bottom: 10px;
        }

        .popup-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .popup-desc {
            color: #777;
            margin-bottom: 20px;
        }
        
        .popup-score {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }

        .popup-content button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }
        
        #resultPopup button {
            background: #667eea;
            color: #fff;
        }

        /* Final Results Popup */
        #finalResultsPopup .popup-content {
            text-align: left;
        }

        #finalResultsPopup h2 {
            text-align: center;
            color: #764ba2;
        }
        
        #finalResultsPopup .final-message {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .final-message.excellent { color: #10b981; }
        .final-message.good { color: #4299e1; }
        .final-message.needs-improvement { color: #dc2626; }

        #finalResultsPopup .result-summary {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            line-height: 1.8;
        }
        
        #finalResultsPopup .result-summary p {
            display: flex;
            justify-content: space-between;
        }
        
        .result-summary .label {
            font-weight: bold;
        }
        
        .result-summary .value {
            color: #667eea;
        }
        
        #finalResultsPopup .popup-content button {
            width: 100%;
            background: #667eea;
            color: #fff;
        }

        /* Student Stats Popup */
        #studentStatsPopup .popup-content {
            max-width: 900px;
            text-align: center;
        }
        
        #studentStatsPopup h2 {
            color: #764ba2;
            margin-bottom: 15px;
        }
        
        #studentStatsPopup .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        #studentStatsPopup .stats-header button {
            background: #10b981;
            color: #fff;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        #studentStatsPopup .stats-header button:hover {
            background: #0d8b67;
        }
        
        #studentStatsPopup .stats-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        #studentStatsPopup table {
            width: 100%;
            border-collapse: collapse;
        }

        #studentStatsPopup thead th {
            position: sticky;
            top: 0;
            background: #667eea;
            color: #fff;
            padding: 10px;
            text-align: left;
            white-space: nowrap;
        }
        
        #studentStatsPopup tbody td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
            text-align: left;
        }
        
        #studentStatsPopup tbody tr:last-child td {
            border-bottom: none;
        }
        
        .score-excellent { color: #10b981; font-weight: bold; }
        .score-good { color: #4299e1; font-weight: bold; }
        .score-needs-improvement { color: #dc2626; font-weight: bold; }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            .stats-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <div class="login-container" id="loginPage">
        <div class="login-box">
            <h1>🧲 Quy tắc bàn tay trái</h1>
            <p>Nhập thông tin để bắt đầu bài kiểm tra.</p>
            <form id="loginForm" onsubmit="startGame(event)">
                <input type="text" id="studentName" placeholder="Họ và tên học sinh" required>
                <input type="text" id="studentClass" placeholder="Lớp" required>
                <button type="submit">Bắt đầu</button>
            </form>
        </div>
    </div>
    
    <div class="game-container" id="gamePage">
        <div class="header">
            <div class="header-left">
                <button class="stats-button" onclick="toggleStats()" id="statsToggle">📊</button>
                <h2 id="playerInfo"></h2>
            </div>
            <div class="header-right">
                <div class="timer-box">Thời gian: <span id="timerDisplay">00:00</span></div>
                <div class="score-box">
                    <span>Điểm: </span><span id="score">0</span>/<span id="total">0</span>
                </div>
            </div>
        </div>
    
        <div class="main-content">
            <div class="problem-panel">
                <h3 id="questionTitle">Câu 1: Tìm đại lượng chưa biết</h3>
                <div class="math-container">
                    <p id="known1"></p>
                    <p id="known2"></p>
                    <p id="unknown"></p>
                </div>
                <div id="canvas-container">
                    <canvas id="canvas"></canvas>
                    <div id="mathOverlay"></div>
                </div>
                <div id="message" class="message"></div>
            </div>
    
            <div class="controls-panel">
                <h4>Xác định hướng của Lực từ:</h4>
                <div class="answer-palette">
                    <div class="answer-option" onclick="selectAnswer('up')">Lên</div>
                    <div class="answer-option" onclick="selectAnswer('down')">Xuống</div>
                    <div class="answer-option" onclick="selectAnswer('left')">Trái</div>
                    <div class="answer-option" onclick="selectAnswer('right')">Phải</div>
                    <div class="answer-option" onclick="selectAnswer('in')">Vào</div>
                    <div class="answer-option" onclick="selectAnswer('out')">Ra</div>
                    <div class="answer-option" onclick="selectAnswer('zero')">= 0</div>
                </div>
                <div class="action-buttons">
                    <button id="checkBtn" onclick="checkAnswer()">Kiểm tra</button>
                    <button id="nextBtn" onclick="newQuestion()">Câu tiếp theo</button>
                </div>
                <button id="finishBtn" onclick="finishExam()">Nộp bài</button>
                <p style="text-align: center; font-size: 0.9em; color: #888; margin-top: 15px;">Mọi dữ liệu được lưu tự động trên hệ thống.</p>
            </div>
        </div>
    </div>
    
    <div class="stats-panel hidden" id="statsPanel">
        <button class="stats-button" onclick="toggleStats()">❌</button>
        <h3>📊 Thống kê chung</h3>
        <div class="stat-item">
            <span class="stat-label">Tổng lượt làm bài</span>
            <span class="stat-value" id="totalGames">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Tổng số câu hỏi</span>
            <span class="stat-value" id="totalQuestions">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Tổng câu trả lời đúng</span>
            <span class="stat-value" id="totalCorrect">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Độ chính xác toàn hệ thống</span>
            <span class="stat-value" id="globalAccuracy">0%</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Điểm cao nhất</span>
            <span class="stat-value" id="highScore">0</span>
        </div>
        <button onclick="showStudentStats()" style="width: 100%; padding: 10px; background: #667eea; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px;">Xem thống kê học sinh</button>
        <button onclick="resetGame()" style="width: 100%; padding: 10px; background: #dc2626; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px;">Đặt lại toàn bộ</button>
    </div>

    <div class="popup-overlay" id="resultPopup">
        <div class="popup-content">
            <span class="popup-icon" id="resultIcon"></span>
            <h2 id="resultTitle"></h2>
            <p class="popup-score">Điểm: <span id="finalScoreDisplay"></span>/<span id="finalTotalDisplay"></span></p>
            <button onclick="closeResultPopup()">Tiếp tục</button>
        </div>
    </div>

    <div class="popup-overlay" id="finalResultsPopup">
        <div class="popup-content">
            <h2>🎉 Hoàn thành bài kiểm tra!</h2>
            <p id="finalMessage" class="final-message"></p>
            <div class="result-summary">
                <p><span class="label">Họ và tên:</span> <span class="value" id="finalName"></span></p>
                <p><span class="label">Lớp:</span> <span class="value" id="finalClass"></span></p>
                <p><span class="label">Số câu đúng:</span> <span class="value" id="finalCorrectCount"></span></p>
                <p><span class="label">Tổng số câu:</span> <span class="value" id="finalTotalCount"></span></p>
                <p><span class="label">Thời gian:</span> <span class="value" id="finalTime"></span></p>
            </div>
            <button onclick="goToLogin()">Làm bài mới</button>
        </div>
    </div>
    
    <div class="popup-overlay" id="studentStatsPopup">
        <div class="popup-content">
            <div class="stats-header">
                <h2>Thống kê chi tiết</h2>
                <button onclick="exportCSV()">Tải CSV</button>
            </div>
            <div class="stats-table-container">
                <table id="statsTable">
                    <thead>
                        <tr>
                            <th>Tên học sinh</th>
                            <th>Lớp</th>
                            <th>Điểm</th>
                            <th>Thời gian</th>
                            <th>Ngày làm</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            <button onclick="closeStudentStatsPopup()">Đóng</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const mathOverlay = document.getElementById('mathOverlay');
        const known1Elem = document.getElementById('known1');
        const known2Elem = document.getElementById('known2');
        const unknownElem = document.getElementById('unknown');
        const answerOptions = document.querySelectorAll('.answer-option');
        const checkBtn = document.getElementById('checkBtn');
        const nextBtn = document.getElementById('nextBtn');
        const messageElem = document.getElementById('message');
        const scoreElem = document.getElementById('score');
        const totalElem = document.getElementById('total');
        const timerDisplay = document.getElementById('timerDisplay');
        const questionTitle = document.getElementById('questionTitle');

        let knowns, unknown, answer, questionCount = 0, correctCount = 0, startTime, timerInterval;
        let selectedAnswer = null;

        let currentPlayer = {};

        // === CLASSES & DATA ===
        const symbols = {
            'B': { text: '$B$', color: '#2b5876' }, // Cảm ứng từ
            'I': { text: '$I$', color: '#4d9f0c' }, // Cường độ dòng điện
            'F': { text: '$F$', color: '#c41a30' }  // Lực từ
        };

        const orientations = {
            'up': { text: 'Lên' },
            'down': { text: 'Xuống' },
            'left': { text: 'Trái' },
            'right': { text: 'Phải' },
            'in': { text: 'Vào' },
            'out': { text: 'Ra' },
            'zero': { text: '= 0' }
        };

        const allDirections = ['up', 'down', 'left', 'right', 'in', 'out'];

        function getRandomDirection(exclude = []) {
            let available = allDirections.filter(dir => !exclude.includes(dir));
            return available[Math.floor(Math.random() * available.length)];
        }

        // === GAME LOGIC ===
        function startGame(event) {
            event.preventDefault();
            const studentName = document.getElementById('studentName').value;
            const studentClass = document.getElementById('studentClass').value;
            if (studentName && studentClass) {
                currentPlayer = {
                    name: studentName,
                    class: studentClass,
                    start: new Date(),
                    correct: 0,
                    total: 0,
                    score: 0
                };
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('gamePage').style.display = 'flex';
                document.getElementById('playerInfo').textContent = `${studentName} - ${studentClass}`;
                startTimer();
                newQuestion();
            }
        }

        function finishExam() {
            clearInterval(timerInterval);
            const duration = new Date() - currentPlayer.start;
            const minutes = Math.floor(duration / 60000);
            const seconds = Math.floor((duration % 60000) / 1000);
            
            currentPlayer.timeTaken = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            currentPlayer.correct = correctCount;
            currentPlayer.total = questionCount;
            currentPlayer.score = correctCount;
            
            saveSession(currentPlayer);
            
            showFinalResults();
        }

        function showFinalResults() {
            document.getElementById('gamePage').style.display = 'none';
            document.getElementById('finalName').textContent = currentPlayer.name;
            document.getElementById('finalClass').textContent = currentPlayer.class;
            document.getElementById('finalCorrectCount').textContent = currentPlayer.correct;
            document.getElementById('finalTotalCount').textContent = currentPlayer.total;
            document.getElementById('finalTime').textContent = currentPlayer.timeTaken;
            
            const percentage = (currentPlayer.correct / currentPlayer.total) * 100 || 0;
            const finalMessage = document.getElementById('finalMessage');
            if (percentage >= 80) {
                finalMessage.textContent = "Bạn đã làm rất tốt!";
                finalMessage.className = "final-message excellent";
            } else if (percentage >= 50) {
                finalMessage.textContent = "Kết quả tốt, hãy cố gắng hơn nữa!";
                finalMessage.className = "final-message good";
            } else {
                finalMessage.textContent = "Hãy ôn tập lại kiến thức nhé!";
                finalMessage.className = "final-message needs-improvement";
            }
            
            document.getElementById('finalResultsPopup').classList.add('show');
        }

        function goToLogin() {
            document.getElementById('finalResultsPopup').classList.remove('show');
            document.getElementById('loginPage').style.display = 'flex';
            resetGameUI();
        }

        function resetGameUI() {
            questionCount = 0;
            correctCount = 0;
            scoreElem.textContent = 0;
            totalElem.textContent = 0;
            timerDisplay.textContent = '00:00';
            messageElem.style.display = 'none';
            selectedAnswer = null;
            newQuestion(); // Bắt đầu lại một câu hỏi mới
        }

        function startTimer() {
            startTime = new Date();
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = now - startTime;
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function newQuestion() {
            messageElem.style.display = 'none';
            nextBtn.style.display = 'none';
            checkBtn.style.display = 'block';
            answerOptions.forEach(option => {
                option.classList.remove('selected', 'correct-answer');
                option.style.pointerEvents = 'auto';
            });
            selectedAnswer = null;

            const quantities = ['B', 'I', 'F'];
            const known1Key = quantities[Math.floor(Math.random() * 3)];
            let known2Key;
            do {
                known2Key = quantities[Math.floor(Math.random() * 3)];
            } while (known2Key === known1Key);
            const unknownKey = quantities.find(q => q !== known1Key && q !== known2Key);
            
            questionCount++;
            questionTitle.textContent = `Câu ${questionCount}: Tìm đại lượng ${symbols[unknownKey].text}`;
            totalElem.textContent = questionCount;

            const known1Dir = getRandomDirection();
            const known2Dir = getRandomDirection([known1Dir]);

            knowns = {
                [known1Key]: known1Dir,
                [known2Key]: known2Dir
            };
            unknown = unknownKey;

            drawCanvas(knowns);
            renderKnowns();
            renderQuestion();
        }

        function renderKnowns() {
            const keys = Object.keys(knowns);
            known1Elem.innerHTML = `Hướng của ${symbols[keys[0]].text}: ${orientations[knowns[keys[0]]].text}`;
            known2Elem.innerHTML = `Hướng của ${symbols[keys[1]].text}: ${orientations[knowns[keys[1]]].text}`;
        }
        
        function renderQuestion() {
            unknownElem.innerHTML = `Xác định hướng của ${symbols[unknown].text} ?`;
        }

        function drawCanvas(knowns) {
            canvas.width = 300;
            canvas.height = 300;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const center = { x: canvas.width / 2, y: canvas.height / 2 };
            const length = 100;
            const arrowSize = 10;
            const offset = 40;

            const positions = {
                'I': { x: center.x, y: center.y - offset },
                'B': { x: center.x - offset, y: center.y },
                'F': { x: center.x, y: center.y + offset }
            };

            const drawArrow = (start, direction, color) => {
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                
                let end = { x: start.x, y: start.y };
                let angle = 0;
                let headPoints = [];

                switch (direction) {
                    case 'up':
                        end.y -= length;
                        angle = -Math.PI / 2;
                        break;
                    case 'down':
                        end.y += length;
                        angle = Math.PI / 2;
                        break;
                    case 'left':
                        end.x -= length;
                        angle = Math.PI;
                        break;
                    case 'right':
                        end.x += length;
                        angle = 0;
                        break;
                    case 'in':
                        ctx.arc(start.x, start.y, 10, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.moveTo(start.x - 5, start.y - 5);
                        ctx.lineTo(start.x + 5, start.y + 5);
                        ctx.moveTo(start.x + 5, start.y - 5);
                        ctx.lineTo(start.x - 5, start.y + 5);
                        ctx.stroke();
                        return;
                    case 'out':
                        ctx.beginPath();
                        ctx.arc(start.x, start.y, 10, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(start.x, start.y, 5, 0, 2 * Math.PI);
                        ctx.stroke();
                        return;
                    case 'zero':
                        return;
                }

                ctx.moveTo(start.x, start.y);
                ctx.lineTo(end.x, end.y);
                ctx.stroke();

                // Draw arrowhead
                ctx.beginPath();
                ctx.fillStyle = color;
                headPoints.push([
                    end.x + arrowSize * Math.cos(angle - Math.PI / 6),
                    end.y + arrowSize * Math.sin(angle - Math.PI / 6)
                ]);
                headPoints.push([
                    end.x,
                    end.y
                ]);
                headPoints.push([
                    end.x + arrowSize * Math.cos(angle + Math.PI / 6),
                    end.y + arrowSize * Math.sin(angle + Math.PI / 6)
                ]);
                ctx.moveTo(headPoints[0][0], headPoints[0][1]);
                ctx.lineTo(headPoints[1][0], headPoints[1][1]);
                ctx.lineTo(headPoints[2][0], headPoints[2][1]);
                ctx.fill();
            };

            Object.keys(knowns).forEach(key => {
                drawArrow(positions[key], knowns[key], symbols[key].color);
            });
        }

        function calculateAnswer(knowns) {
            const [key1, key2] = Object.keys(knowns);
            const dir1 = knowns[key1];
            const dir2 = knowns[key2];

            const directions = {
                'up': { x: 0, y: -1, z: 0 },
                'down': { x: 0, y: 1, z: 0 },
                'left': { x: -1, y: 0, z: 0 },
                'right': { x: 1, y: 0, z: 0 },
                'in': { x: 0, y: 0, z: 1 },
                'out': { x: 0, y: 0, z: -1 }
            };

            const vector1 = directions[dir1];
            const vector2 = directions[dir2];

            const resultVector = {};
            if (knowns.I && knowns.B) {
                resultVector.x = vector2.y * vector1.z - vector2.z * vector1.y;
                resultVector.y = vector2.z * vector1.x - vector2.x * vector1.z;
                resultVector.z = vector2.x * vector1.y - vector2.y * vector1.x;
            } else if (knowns.F && knowns.I) {
                resultVector.x = vector1.y * vector2.z - vector1.z * vector2.y;
                resultVector.y = vector1.z * vector2.x - vector1.x * vector2.z;
                resultVector.z = vector1.x * vector2.y - vector1.y * vector2.x;
            } else if (knowns.F && knowns.B) {
                resultVector.x = vector2.y * vector1.z - vector2.z * vector1.y;
                resultVector.y = vector2.z * vector1.x - vector2.x * vector1.z;
                resultVector.z = vector2.x * vector1.y - vector2.y * vector1.x;
            }

            if (resultVector.x === 0 && resultVector.y === 0 && resultVector.z === 0) {
                return 'zero';
            }

            if (resultVector.y === -1 && resultVector.x === 0 && resultVector.z === 0) return 'up';
            if (resultVector.y === 1 && resultVector.x === 0 && resultVector.z === 0) return 'down';
            if (resultVector.x === -1 && resultVector.y === 0 && resultVector.z === 0) return 'left';
            if (resultVector.x === 1 && resultVector.y === 0 && resultVector.z === 0) return 'right';
            if (resultVector.z === 1 && resultVector.x === 0 && resultVector.y === 0) return 'in';
            if (resultVector.z === -1 && resultVector.x === 0 && resultVector.y === 0) return 'out';
            
            return 'zero';
        }

        function checkAnswer() {
            if (!selectedAnswer) {
                alert('Vui lòng chọn một đáp án.');
                return;
            }

            const correctAnswer = calculateAnswer(knowns);

            const selectedOption = document.querySelector(`.answer-option.selected`);
            if (selectedAnswer === correctAnswer) {
                correctCount++;
                scoreElem.textContent = correctCount;
                messageElem.textContent = 'Chính xác! 🎉';
                messageElem.className = 'message correct';
                selectedOption.classList.add('correct-answer');
                
                const correctOption = document.querySelector(`.answer-option[onclick="selectAnswer('${correctAnswer}')"]`);
                if (correctOption) {
                    correctOption.classList.add('correct-answer');
                }
            } else {
                messageElem.textContent = `Sai rồi. Đáp án đúng là: ${orientations[correctAnswer].text}.`;
                messageElem.className = 'message incorrect';
                
                const correctOption = document.querySelector(`.answer-option[onclick="selectAnswer('${correctAnswer}')"]`);
                if (correctOption) {
                    correctOption.classList.add('correct-answer');
                }
            }
            messageElem.style.display = 'block';

            answerOptions.forEach(option => option.style.pointerEvents = 'none');
            checkBtn.style.display = 'none';
            nextBtn.style.display = 'block';
        }

        function selectAnswer(answer) {
            selectedAnswer = answer;
            answerOptions.forEach(option => option.classList.remove('selected'));
            document.querySelector(`.answer-option[onclick="selectAnswer('${answer}')"]`).classList.add('selected');
        }

        // === FIREBASE & STATISTICS ===
        
        async function saveSession(session) {
            try {
                const sessionRef = database.ref('studentSessions').push();
                sessionRef.set({
                    name: session.name,
                    class: session.class,
                    score: session.score,
                    total: session.total,
                    time: session.timeTaken,
                    timestamp: new Date().toISOString()
                });
                console.log("Session saved successfully to Firebase!");
            } catch (error) {
                console.error("Error saving session to Firebase:", error);
            }
        }
        
        async function fetchStats() {
            try {
                const snapshot = await database.ref('studentSessions').once('value');
                const sessions = snapshot.val();
                if (!sessions) return { totalGames: 0, totalQuestions: 0, totalCorrect: 0, highScore: 0 };
        
                let totalGames = 0, totalQuestions = 0, totalCorrect = 0, highScore = 0;
                
                Object.values(sessions).forEach(session => {
                    totalGames++;
                    totalQuestions += session.total;
                    totalCorrect += session.score;
                    if (session.score > highScore) {
                        highScore = session.score;
                    }
                });
        
                return {
                    totalGames,
                    totalQuestions,
                    totalCorrect,
                    highScore
                };
            } catch (error) {
                console.error("Error fetching stats from Firebase:", error);
                return { totalGames: 0, totalQuestions: 0, totalCorrect: 0, highScore: 0 };
            }
        }

        async function fetchStudentSessions() {
            try {
                const snapshot = await database.ref('studentSessions').orderByChild('timestamp').once('value');
                const sessions = snapshot.val();
                if (!sessions) return [];
                
                return Object.values(sessions).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            } catch (error) {
                console.error("Error fetching student sessions from Firebase:", error);
                return [];
            }
        }

        async function exportCSV(sessions) {
            if (sessions.length === 0) {
                alert("Không có dữ liệu để xuất.");
                return;
            }
            const headers = ["Tên học sinh", "Lớp", "Điểm", "Tổng số câu", "Thời gian", "Ngày làm"];
            const csvRows = [headers.join(',')];

            sessions.forEach(session => {
                const date = new Date(session.timestamp).toLocaleString('vi-VN');
                const row = [
                    `"${session.name}"`,
                    `"${session.class}"`,
                    session.score,
                    session.total,
                    session.time,
                    `"${date}"`
                ].join(',');
                csvRows.push(row);
            });
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'thong_ke_quy_tac_ban_tay_trai.csv');
            link.click();
        }

        function resetAllFirebaseData() {
            if (confirm('⚠️ Bạn có chắc muốn xóa tất cả thống kê trên Firebase? Hành động này không thể hoàn tác!')) {
                database.ref('studentSessions').remove()
                    .then(() => {
                        alert("Đã xóa toàn bộ dữ liệu thành công!");
                        location.reload();
                    })
                    .catch((error) => {
                        alert("Lỗi khi xóa dữ liệu:", error.message);
                    });
            }
        }

        async function updateStatsPanel() {
            const stats = await fetchStats();
            document.getElementById('totalGames').textContent = stats.totalGames;
            document.getElementById('totalQuestions').textContent = stats.totalQuestions;
            document.getElementById('totalCorrect').textContent = stats.totalCorrect;
            document.getElementById('highScore').textContent = stats.highScore;
            const accuracy = stats.totalQuestions > 0 ? ((stats.totalCorrect / stats.totalQuestions) * 100).toFixed(1) : 0;
            document.getElementById('globalAccuracy').textContent = `${accuracy}%`;
        }

        async function showStudentStats() {
            const sessions = await fetchStudentSessions();
            const tableBody = document.querySelector('#statsTable tbody');
            tableBody.innerHTML = '';
            
            if (sessions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">Không có bản ghi nào.</td></tr>';
            } else {
                sessions.forEach(session => {
                    const row = document.createElement('tr');
                    const date = new Date(session.timestamp).toLocaleString('vi-VN');
                    
                    let scoreClass = '';
                    const percentage = (session.score / session.total) * 100 || 0;
                    if (percentage >= 80) scoreClass = 'score-excellent';
                    else if (percentage >= 50) scoreClass = 'score-good';
                    else scoreClass = 'score-needs-improvement';
                    
                    row.innerHTML = `
                        <td>${session.name}</td>
                        <td>${session.class}</td>
                        <td class="${scoreClass}">${session.score}/${session.total}</td>
                        <td>${session.time}</td>
                        <td>${date}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            const exportButton = document.querySelector('#studentStatsPopup .stats-header button');
            exportButton.onclick = () => exportCSV(sessions);
            document.getElementById('studentStatsPopup').classList.add('show');
        }

        function closeStudentStatsPopup() {
            document.getElementById('studentStatsPopup').classList.remove('show');
        }

        function toggleStats() {
            const statsPanel = document.getElementById('statsPanel');
            const isHidden = statsPanel.classList.contains('hidden');
            if (isHidden) {
                updateStatsPanel();
                statsPanel.classList.remove('hidden');
            } else {
                statsPanel.classList.add('hidden');
            }
        }
        
        document.querySelector("#statsPanel button:last-child").onclick = resetAllFirebaseData;
        
    </script>
</body>
</html>