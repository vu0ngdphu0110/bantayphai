<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧲⚡ Quy tắc bàn tay trái - Xác định lực từ</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        
        .login-title {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .login-subtitle {
            font-size: 1.2em;
            color: #4a5568;
            margin-bottom: 30px;
        }
        
        .form-group {
            text-align: left;
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #4299e1;
        }
        
        .login-btn {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(66, 153, 225, 0.3);
        }
        
        /* Game Styles */
        .game-container {
            width: 100vw;
            height: 100vh;
            background: white;
            position: relative;
            display: none;
        }
        
        .header {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 { font-size: 2em; margin-bottom: 8px; }
        .header p { font-size: 1.1em; }
        
        .question-section {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-width: 500px;
            display: none;
        }
        
        .question-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .question-details {
            display: flex;
            gap: 15px;
            justify-content: flex-start;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .question-item {
            background: #f0f9ff;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 600;
        }
        
        .question-item.known {
            color: #10b981;
            border: 2px solid #10b981;
        }
        
        .question-item.unknown {
            color: #dc2626;
            border: 2px solid #dc2626;
            background: #fef2f2;
        }
        
        .left-panel {
            position: absolute;
            top: 120px;
            left: 20px;
            width: 260px;
            height: calc(100vh - 140px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 8px 0 32px rgba(0, 0, 0, 0.1);
            padding: 12px;
            overflow-y: auto;
            overflow-x: hidden;
            display: grid;
            grid-template-rows: auto auto 1fr;
            gap: 10px;
        }
        
        .right-panel {
            position: absolute;
            top: 120px;
            right: 20px;
            width: 260px;
            height: calc(100vh - 140px);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: -8px 0 32px rgba(0, 0, 0, 0.1);
            padding: 12px;
            overflow-y: auto;
            overflow-x: hidden;
            display: grid;
            grid-template-rows: auto auto auto 1fr;
            gap: 10px;
        }
        
        .canvas-area {
            position: absolute;
            top: 240px;
            left: 300px;
            width: calc(100vw - 580px);
            height: calc(100vh - 260px);
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 15px;
            overflow: hidden;
        }
        
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .math-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        
        .math-label {
            position: absolute;
            font-size: 22px;
            font-weight: bold;
            color: #2563eb;
        }
        
        .math-label.force { color: #8b5cf6; }
        .math-label.force-correct { color: #dc2626; font-size: 28px; }
        .math-label.force-user { color: #8b5cf6; font-size: 28px; }
        .math-label.current { color: #10b981; font-size: 24px; }
        .math-label.unknown { color: #dc2626; }
        
        .section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .section h3 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .answer-palette {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        
        .answer-option {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 10px 6px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 13px;
            user-select: none;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px solid transparent;
        }
        
        .answer-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
        }
        
        .answer-option.selected {
            border-color: #dc2626;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.5);
            animation: pulse-red 1s infinite;
        }
        
        .answer-option.zero-answer {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            grid-column: span 3;
        }
        
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 15px rgba(220, 38, 38, 0.5); }
            50% { box-shadow: 0 0 25px rgba(220, 38, 38, 0.8); }
        }
        
        .btn {
            width: 100%;
            padding: 10px;
            margin: 3px 0;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary { background: linear-gradient(135deg, #4299e1, #3182ce); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ed8936, #dd6b20); color: white; }
        .btn-danger { background: linear-gradient(135deg, #f56565, #e53e3e); color: white; }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .score-board {
            background: linear-gradient(135deg, #38b2ac, #319795);
            color: white;
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .timer-board {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .timer-display {
            font-size: 20px;
            font-family: 'Courier New', monospace;
            margin: 6px 0;
        }
        
        .score-item {
            margin: 4px 0;
            font-size: 14px;
        }
        
        .player-name {
            font-size: 14px;
            margin-bottom: 8px;
            padding: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
        }
        
        .message {
            padding: 8px;
            border-radius: 8px;
            margin: 6px 0;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }
        
        .message.correct {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #48bb78;
        }
        
        .message.incorrect {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #f56565;
        }
        
        .message.info {
            background: #e6fffa;
            color: #234e52;
            border: 2px solid #38b2ac;
        }
        
        .instructions {
            background: #e6fffa;
            border-left: 3px solid #38b2ac;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 6px;
            line-height: 1.4;
        }
        
        .physics-note {
            background: #fff5f5;
            border: 1px solid #fc8181;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            color: #742a2a;
            margin-top: 6px;
            line-height: 1.4;
        }
        
        /* Popups */
        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .popup.show {
            opacity: 1;
            visibility: visible;
        }
        
        .popup-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }
        
        .popup.show .popup-content {
            transform: scale(1);
        }
        
        .popup-icon { font-size: 80px; margin-bottom: 20px; }
        .popup-title { font-size: 32px; font-weight: bold; margin-bottom: 15px; }
        .popup-desc { font-size: 18px; margin-bottom: 25px; line-height: 1.5; }
        .popup-score {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 20px;
            font-weight: bold;
            margin: 20px 0;
            display: inline-block;
        }
        
        .close-btn {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 5px;
        }
        
        .close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(66, 153, 225, 0.3);
        }
        
        .restart-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 5px;
        }
        
        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }
        
        /* Final Results Popup */
        .final-results {
            background: linear-gradient(135deg, #fef7cd, #fef3c7);
            border: 8px solid #d97706;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }
        
        .final-results-header { 
            font-size: 48px; 
            margin-bottom: 20px; 
        }
        
        .final-results-title {
            font-size: 28px;
            font-weight: bold;
            color: #92400e;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        
        .final-results-student {
            font-size: 24px;
            color: #1f2937;
            margin: 20px 0;
            font-weight: 600;
        }
        
        .final-results-stats {
            background: rgba(255, 255, 255, 0.7);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #d97706;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-item {
            background: rgba(217, 119, 6, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #d97706;
        }
        
        .stat-label {
            font-size: 14px;
            color: #92400e;
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
        }
        
        .final-message {
            margin: 20px 0;
            padding: 20px;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
        }
        
        .final-message.excellent {
            background: rgba(34, 197, 94, 0.1);
            border: 3px solid #22c55e;
            color: #15803d;
        }
        
        .final-message.good {
            background: rgba(251, 191, 36, 0.1);
            border: 3px solid #fbbf24;
            color: #92400e;
        }
        
        .final-message.needs-improvement {
            background: rgba(239, 68, 68, 0.1);
            border: 3px solid #ef4444;
            color: #991b1b;
        }
        
        /* Statistics Panel */
        .stats-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 2px solid #e2e8f0;
            min-width: 200px;
            z-index: 1500;
        }
        
        .stats-header {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 13px;
        }
        
        .stats-item:last-child {
            border-bottom: none;
        }
        
        .stats-label {
            color: #4a5568;
            font-weight: 600;
        }
        
        .stats-value {
            color: #2d3748;
            font-weight: bold;
            background: #f7fafc;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .stats-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(66, 153, 225, 0.3);
            z-index: 1600;
            transition: all 0.3s ease;
        }
        
        .stats-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4);
        }
        
        .stats-panel.hidden {
            display: none;
        }
        
        .stats-btn {
            width: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin: 3px 0;
            transition: all 0.3s ease;
        }
        
        .stats-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        /* Student Statistics Table */
        .student-stats-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .student-stats-popup.show {
            opacity: 1;
            visibility: visible;
        }
        
        .student-stats-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 95vw;
            max-height: 90vh;
            width: 1200px;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .student-stats-popup.show .student-stats-content {
            transform: scale(1);
        }
        
        .stats-table-header {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .stats-table-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stats-table-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .stats-table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .stats-table th {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            color: #2d3748;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid #cbd5e0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .stats-table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .stats-table tbody tr:hover {
            background: #f7fafc;
        }
        
        .stats-table tbody tr:nth-child(even) {
            background: #fafafa;
        }
        
        .stats-table tbody tr:nth-child(even):hover {
            background: #f0f9ff;
        }
        
        .score-excellent { color: #059669; font-weight: bold; }
        .score-good { color: #d97706; font-weight: bold; }
        .score-needs-improvement { color: #dc2626; font-weight: bold; }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 2px solid #0ea5e9;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .summary-label {
            font-size: 14px;
            color: #0369a1;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #1e40af;
        }
        
        .close-stats-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 10px 0 0;
            transition: all 0.3s ease;
        }
        
        .close-stats-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }
        
        .export-csv-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 10px 0 0;
            transition: all 0.3s ease;
        }
        
        .export-csv-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        
        /* Custom Scrollbar */
        .left-panel::-webkit-scrollbar,
        .right-panel::-webkit-scrollbar {
            width: 8px;
        }
        
        .left-panel::-webkit-scrollbar-track,
        .right-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        
        .left-panel::-webkit-scrollbar-thumb,
        .right-panel::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            border-radius: 10px;
        }
        
        .left-panel::-webkit-scrollbar-thumb:hover,
        .right-panel::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #3182ce, #2c5282);
        }
        
        /* Firefox scrollbar */
        .left-panel,
        .right-panel {
            scrollbar-width: thin;
            scrollbar-color: #4299e1 rgba(0, 0, 0, 0.1);
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .game-container {
                display: flex;
                flex-direction: column;
                padding: 10px;
            }
            
            .question-section, .right-panel, .canvas-area, .left-panel {
                position: relative;
                transform: none;
                left: 0;
                top: 0;
                width: 100%;
                margin: 10px 0;
                padding: 15px;
                height: auto;
                overflow: visible;
            }
            
            .question-section { order: 1; max-width: none; }
            .right-panel { order: 2; }
            .canvas-area { order: 3; height: 300px; }
            .left-panel { order: 4; }
            
            .answer-option {
                padding: 12px 6px;
                font-size: 13px;
                min-height: 55px;
            }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <h1 class="login-title">🧲⚡ Quy tắc bàn tay trái</h1>
            <p class="login-subtitle">Xác định lực từ</p>
            
            <form onsubmit="startGame(event)">
                <div class="form-group">
                    <label for="studentName">Tên học sinh</label>
                    <input type="text" id="studentName" required placeholder="Nhập tên của bạn">
                </div>
                
                <div class="form-group">
                    <label for="studentClass">Lớp</label>
                    <input type="text" id="studentClass" required placeholder="Ví dụ: 12A1">
                </div>
                
                <button type="submit" class="login-btn">Bắt đầu học tập</button>
            </form>
        </div>
    </div>

    <div id="gamePage" class="game-container">
        <div class="header">
            <h1>🧲⚡ Quy tắc bàn tay trái - Xác định lực từ</h1>
            <p>Áp dụng công thức: $\vec{F} = I \vec{l} \times \vec{B}$ - Tam diện thuận $\vec{B}$, $I$, $\vec{F}$</p>
        </div>
        
        <div id="questionSection" class="question-section">
            <div class="question-title" id="questionTitle">Câu 1: Tìm đại lượng chưa biết</div>
            <div class="question-details">
                <div class="question-item known" id="knownItem1">
                    <span id="known1">Đã biết 1</span>
                </div>
                <div class="question-item known" id="knownItem2">
                    <span id="known2">Đã biết 2</span>
                </div>
                <div class="question-item unknown" id="unknownItem">
                    <span id="unknown">Cần tìm: ?</span>
                </div>
            </div>
        </div>
        
        <div class="canvas-area">
            <canvas id="canvas"></canvas>
            <div class="math-overlay" id="mathOverlay"></div>
        </div>
        
        <div class="left-panel">
            <div class="section">
                <h3 id="answerTitle">🎯 Chọn câu trả lời</h3>
                <div class="answer-palette" id="answerPalette">
                    <div class="answer-option" onclick="selectAnswer('up')">↑<br>Lên</div>
                    <div class="answer-option" onclick="selectAnswer('down')">↓<br>Xuống</div>
                    <div class="answer-option" onclick="selectAnswer('left')">←<br>Trái</div>
                    <div class="answer-option" onclick="selectAnswer('right')">→<br>Phải</div>
                    <div class="answer-option" onclick="selectAnswer('out')">●<br>Ra</div>
                    <div class="answer-option" onclick="selectAnswer('in')">×<br>Vào</div>
                    <div class="answer-option zero-answer" onclick="selectAnswer('zero')" id="zeroOption">= 0</div>
                </div>
            </div>
            
            <div class="section">
                <h3>🎮 Thao tác</h3>
                <button class="btn btn-primary" onclick="newQuestion()">🎲 Câu hỏi mới</button>
                <button class="btn btn-warning" onclick="checkAnswer()" id="checkBtn" disabled>✅ Kiểm tra đáp án</button>
                <button class="btn btn-danger" onclick="finishExam()">🏁 Kết thúc bài làm</button>
                <button class="btn btn-danger" onclick="resetGame()">🔄 Đặt lại</button>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="section">
                <div class="timer-board">
                    <div>⏱️ Thời gian</div>
                    <div class="timer-display" id="timerDisplay">00:00</div>
                    <div style="font-size: 14px;">Đã làm bài</div>
                </div>
            </div>
            
            <div class="section">
                <div class="score-board">
                    <div class="player-name" id="playerInfo">Học sinh</div>
                    <div class="score-item">🏆 Điểm: <span id="score">0</span></div>
                    <div class="score-item">📊 Tổng: <span id="total">0</span></div>
                    <div class="score-item">📈 Đúng: <span id="accuracy">0%</span></div>
                </div>
            </div>
            
            <div class="section">
                <h3>📚 Hướng dẫn</h3>
                <div class="instructions">
                    <ul>
                        <li>Quan sát 2 đại lượng đã biết</li>
                        <li><strong>Chọn</strong> hướng của đại lượng còn lại</li>
                        <li>Áp dụng quy tắc bàn tay trái</li>
                        <li>$\vec{B}$, $I$, $\vec{F}$ tạo tam diện thuận</li>
                    </ul>
                </div>
                <div class="physics-note">
                    <strong>⚠️ Lưu ý:</strong> Nếu hai đại lượng song song thì đại lượng thứ 3 = 0
                </div>
                <div id="message"></div>
            </div>
        </div>
    </div>

    <div id="resultPopup" class="popup">
        <div class="popup-content">
            <div id="popupIcon" class="popup-icon">🎉</div>
            <div id="popupTitle" class="popup-title">Chính xác!</div>
            <div id="popupDesc" class="popup-desc">Bạn đã áp dụng đúng quy tắc bàn tay trái!</div>
            <div id="popupScore" class="popup-score">+1 điểm</div>
            <button class="close-btn" onclick="closePopup()">Tiếp tục</button>
        </div>
    </div>

    <div id="finalResultsPopup" class="popup">
        <div class="final-results">
            <div class="final-results-header">🏆</div>
            <div class="final-results-title">Kết quả bài làm</div>
            <div class="final-results-student" id="finalResultsStudent">Học sinh: [Tên]</div>
            
            <div class="final-results-stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Tổng câu hỏi</div>
                        <div class="stat-value" id="finalTotal">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Câu trả lời đúng</div>
                        <div class="stat-value" id="finalCorrect">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Tỷ lệ chính xác</div>
                        <div class="stat-value" id="finalAccuracy">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Thời gian làm bài</div>
                        <div class="stat-value" id="finalTime">00:00</div>
                    </div>
                </div>
                <div class="final-message" id="finalMessage"> 🎉 Chúc mừng! Bạn đã hoàn thành xuất sắc! </div>
            </div>
            <div style="margin-top: 20px;">
                <button class="close-btn" onclick="closeFinalResults()">Đóng</button>
                <button class="restart-btn" onclick="restartGame()">🔄 Chơi lại</button>
            </div>
        </div>
    </div>

    <div id="studentStatsPopup" class="student-stats-popup">
        <div class="student-stats-content">
            <div class="stats-table-header">
                <div class="stats-table-title">📊 Thống kê học sinh tháng <span id="currentMonth"></span></div>
                <div class="stats-table-subtitle">Dữ liệu chi tiết về kết quả học tập của từng học sinh</div>
            </div>
            <div class="stats-summary" id="statsSummary">
                </div>
            <div class="stats-table-container">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Họ tên</th>
                            <th>Lớp</th>
                            <th>Ngày</th>
                            <th>Lượt truy cập</th>
                            <th>Câu làm</th>
                            <th>Câu đúng</th>
                            <th>Câu sai</th>
                            <th>Tỷ lệ (%)</th>
                            <th>Điểm (10)</th>
                            <th>Điểm (100)</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody">
                        </tbody>
                </table>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="close-stats-btn" onclick="closeStudentStats()">✖️ Đóng</button>
                <button class="export-csv-btn" onclick="exportCSV()">📊 Xuất CSV</button>
            </div>
        </div>
    </div>

    <button id="statsToggle" class="stats-toggle" onclick="toggleStats()" title="Xem thống kê">📊</button>
    <div id="statsPanel" class="stats-panel hidden">
        <div class="stats-header">📊 Thống kê hệ thống</div>
        <div class="stats-item">
            <span class="stats-label">🌐 Lượt truy cập:</span>
            <span class="stats-value" id="totalVisits">0</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">👥 Người dùng:</span>
            <span class="stats-value" id="totalUsers">0</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">🎮 Lượt chơi:</span>
            <span class="stats-value" id="totalGames">0</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">❓ Câu hỏi:</span>
            <span class="stats-value" id="totalQuestions">0</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">✅ Đúng:</span>
            <span class="stats-value" id="totalCorrect">0</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">📈 Tỷ lệ đúng:</span>
            <span class="stats-value" id="globalAccuracy">0%</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">⏱️ Thời gian TB:</span>
            <span class="stats-value" id="avgTime">00:00</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">🏆 Điểm cao nhất:</span>
            <span class="stats-value" id="highScore">0</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">📅 Hôm nay:</span>
            <span class="stats-value" id="todayVisits">0</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">🔥 Streak:</span>
            <span class="stats-value" id="currentStreak">0</span>
        </div>
        <div style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #e2e8f0;">
            <button class="stats-btn" onclick="showStudentStats()" title="Xem bảng thống kê học sinh">
                📋 Bảng thống kê
            </button>
            <button class="stats-btn" onclick="exportCSV()" title="Tải file CSV thống kê tháng này">
                📊 Xuất CSV
            </button>
        </div>
    </div>
<script>
    // Sửa đường link API tại đây
    const API_URL = "https://script.google.com/macros/s/AKfycbyBj7Yw73Iu8jHb8aEJlsmopsLu7JYfFs_tsaGOiLswB5w9z-OWmceNloLPGERig02p/exec";

    let game;
    let studentName = '';
    let studentClass = '';
    let statsManager;

    // Statistics Manager Class
    class StatisticsManager {
        constructor() {
            this.initializeStats();
            this.trackVisit();
            this.updateDisplay();
            // Auto-update every 30 seconds
            setInterval(() => {
                this.updateDisplay();
            }, 30000);
        }

        initializeStats() {
            // Initialize default stats if not exists
            const defaultStats = {
                totalVisits: 0,
                totalUsers: 0,
                totalGames: 0,
                totalQuestions: 0,
                totalCorrect: 0,
                totalTime: 0,
                highScore: 0,
                todayVisits: 0,
                lastVisitDate: null,
                currentStreak: 0,
                lastStreakDate: null,
                userSessions: {},
                dailyStats: {}
            };
            // Load existing stats or use defaults
            this.stats = this.loadStats() || defaultStats;
            this.saveStats();
        }

        async loadStats() {
            try {
                const res = await fetch(API_URL);
                return await res.json();
            } catch (e) {
                console.warn("Could not load stats:", e);
                return null;
            }
        }

        saveStats() {
            fetch(API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    action: "updateGlobal",
                    totalVisits: this.stats.totalVisits,
                    totalUsers: this.stats.totalUsers,
                    totalGames: this.stats.totalGames,
                    totalQuestions: this.stats.totalQuestions,
                    totalCorrect: this.stats.totalCorrect,
                    highScore: this.stats.highScore,
                    totalTime: this.stats.totalTime,
                    todayVisits: this.stats.todayVisits,
                    currentStreak: this.stats.currentStreak,
                    lastStreakDate: this.stats.lastStreakDate
                })
            });
        }

        trackVisit() {
            const today = new Date().toDateString();
            const now = Date.now();
            // Increment total visits
            this.stats.totalVisits++;

            // Track daily visits
            if (!this.stats.dailyStats[today]) {
                this.stats.dailyStats[today] = {
                    visits: 0,
                    games: 0,
                    questions: 0,
                    correct: 0
                };
            }
            this.stats.dailyStats[today].visits++;
            this.stats.todayVisits = this.stats.dailyStats[today].visits;

            // Update streak
            this.updateStreak(today);

            // Clean old daily stats (keep only last 30 days)
            this.cleanOldStats();
            this.saveStats();
        }

        updateStreak(today) {
            const lastDate = this.stats.lastStreakDate;
            if (!lastDate) {
                // First visit
                this.stats.currentStreak = 1;
            } else {
                const lastVisit = new Date(lastDate);
                const todayDate = new Date(today);
                const diffTime = todayDate - lastVisit;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays === 1) {
                    // Consecutive day
                    this.stats.currentStreak++;
                } else if (diffDays > 1) {
                    // Streak broken
                    this.stats.currentStreak = 1;
                }
                // Same day = no change
            }
            this.stats.lastStreakDate = today;
        }

        cleanOldStats() {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            Object.keys(this.stats.dailyStats).forEach(date => {
                if (new Date(date) < thirtyDaysAgo) {
                    delete this.stats.dailyStats[date];
                }
            });
        }

        trackUser(name, className) {
            const userKey = `${name}_${className}`;
            if (!this.stats.userSessions[userKey]) {
                this.stats.totalUsers++;
                this.stats.userSessions[userKey] = {
                    name: name,
                    studentClass: className,
                    firstVisit: Date.now(),
                    sessions: 0,
                    totalQuestions: 0,
                    totalCorrect: 0,
                    bestScore: 0,
                    totalTime: 0
                };
            }
            this.stats.userSessions[userKey].sessions++;
            this.saveStats();
        }

        trackGameStart() {
            const today = new Date().toDateString();
            this.stats.totalGames++;
            if (this.stats.dailyStats[today]) {
                this.stats.dailyStats[today].games++;
            }
            this.saveStats();
            this.updateDisplay();
        }

        trackQuestion(isCorrect) {
            const today = new Date().toDateString();
            this.stats.totalQuestions++;
            if (isCorrect) {
                this.stats.totalCorrect++;
            }
            if (this.stats.dailyStats[today]) {
                this.stats.dailyStats[today].questions++;
                if (isCorrect) {
                    this.stats.dailyStats[today].correct++;
                }
            }
            // Update user stats
            const userKey = `${studentName}_${studentClass}`;
            if (this.stats.userSessions[userKey]) {
                this.stats.userSessions[userKey].totalQuestions++;
                if (isCorrect) {
                    this.stats.userSessions[userKey].totalCorrect++;
                }
            }
            this.saveStats();
            this.updateDisplay();
        }

        updateDisplay() {
            document.getElementById('totalVisits').innerText = this.stats.totalVisits;
            document.getElementById('totalUsers').innerText = this.stats.totalUsers;
            document.getElementById('totalGames').innerText = this.stats.totalGames;
            document.getElementById('totalQuestions').innerText = this.stats.totalQuestions;
            document.getElementById('totalCorrect').innerText = this.stats.totalCorrect;
            document.getElementById('todayVisits').innerText = this.stats.todayVisits;
            document.getElementById('currentStreak').innerText = this.stats.currentStreak;
            if (this.stats.totalQuestions > 0) {
                const globalAccuracy = (this.stats.totalCorrect / this.stats.totalQuestions * 100).toFixed(1);
                document.getElementById('globalAccuracy').innerText = `${globalAccuracy}%`;
            } else {
                document.getElementById('globalAccuracy').innerText = '0%';
            }
            document.getElementById('highScore').innerText = this.stats.highScore;
            // Update avg time
        }
        
        // This function will fetch student session data from Google Sheet
        async getStudentSessions() {
            try {
                const res = await fetch(API_URL + "?action=getStudentSessions");
                const sessions = await res.json();
                return sessions;
            } catch (e) {
                console.warn("Could not fetch student sessions:", e);
                return [];
            }
        }

        exportStats() {
            // For now, this is a placeholder. You would need to implement a server-side
            // script to handle the CSV generation and download.
            alert("Tính năng xuất thống kê đang được phát triển.");
        }
        
        addSessionToSheet(sessionData) {
            const payload = {
                action: "addSession",
                ...sessionData
            };
            fetch(API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams(payload)
            }).then(response => response.text())
            .then(data => {
                console.log("Session saved to Google Sheet:", data);
            }).catch(error => {
                console.error("Error saving session:", error);
            });
        }
    }

    class Game {
        constructor() {
            this.correct = 0;
            this.total = 0;
            this.score = 0;
            this.isAnswered = false;
            this.selectedAnswer = '';
            this.questionData = {};
            this.startTime = 0;
            this.timerInterval = null;
            this.canvas = document.getElementById('canvas');
            this.ctx = this.canvas.getContext('2d');
            this.answers = ['up', 'down', 'left', 'right', 'in', 'out', 'zero'];
            this.vectors = {
                'up': { x: 0, y: -1, label: '↑ B', color: '#4299e1' },
                'down': { x: 0, y: 1, label: '↓ B', color: '#4299e1' },
                'left': { x: -1, y: 0, label: '← B', color: '#4299e1' },
                'right': { x: 1, y: 0, label: '→ B', color: '#4299e1' },
                'in': { x: 0, y: 0, label: '× B', color: '#4299e1' },
                'out': { x: 0, y: 0, label: '● B', color: '#4299e1' }
            };
            this.vectorLabels = {
                'up': 'Lên', 'down': 'Xuống', 'left': 'Trái', 'right': 'Phải', 'in': 'Vào', 'out': 'Ra', 'zero': '= 0'
            };
            
            // Initial call
            this.newQuestion();
            this.startTimer();
        }

        startTimer() {
            this.startTime = Date.now();
            this.timerInterval = setInterval(() => {
                const elapsed = Date.now() - this.startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('timerDisplay').innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        stopTimer() {
            clearInterval(this.timerInterval);
        }

        getElapsedTime() {
            const elapsed = Date.now() - this.startTime;
            return Math.floor(elapsed / 1000); // seconds
        }

        drawGrid() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.beginPath();
            this.ctx.strokeStyle = '#e2e8f0';
            this.ctx.lineWidth = 1;
            const size = 50;
            for (let x = 0; x < this.canvas.width; x += size) {
                this.ctx.moveTo(x, 0);
                this.ctx.lineTo(x, this.canvas.height);
            }
            for (let y = 0; y < this.canvas.height; y += size) {
                this.ctx.moveTo(0, y);
                this.ctx.lineTo(this.canvas.width, y);
            }
            this.ctx.stroke();
        }

        drawVector(vector, color, label, isCurrent = false) {
            const center = { x: this.canvas.width / 2, y: this.canvas.height / 2 };
            const scale = 50;
            const headlen = 10;
            const from = { x: center.x, y: center.y };
            const to = { x: center.x + vector.x * scale, y: center.y + vector.y * scale };
            
            this.ctx.beginPath();
            this.ctx.moveTo(from.x, from.y);
            this.ctx.lineTo(to.x, to.y);
            this.ctx.strokeStyle = color;
            this.ctx.lineWidth = 3;
            this.ctx.stroke();

            // Arrowhead
            const angle = Math.atan2(to.y - from.y, to.x - from.x);
            this.ctx.moveTo(to.x, to.y);
            this.ctx.lineTo(to.x - headlen * Math.cos(angle - Math.PI / 6), to.y - headlen * Math.sin(angle - Math.PI / 6));
            this.ctx.moveTo(to.x, to.y);
            this.ctx.lineTo(to.x - headlen * Math.cos(angle + Math.PI / 6), to.y - headlen * Math.sin(angle + Math.PI / 6));
            this.ctx.stroke();

            // Label
            const mathOverlay = document.getElementById('mathOverlay');
            const labelEl = document.createElement('div');
            labelEl.className = 'math-label';
            labelEl.style.left = `${to.x + 10}px`;
            labelEl.style.top = `${to.y - 20}px`;
            labelEl.innerText = label;
            if (label.includes('F')) {
                labelEl.classList.add('force');
            } else if (label.includes('I')) {
                labelEl.classList.add('current');
            }
            if (isCurrent) {
                labelEl.classList.add('force-user');
            }
            mathOverlay.appendChild(labelEl);
        }
        
        drawCircularVector(direction, color, label) {
            const center = { x: this.canvas.width / 2, y: this.canvas.height / 2 };
            this.ctx.beginPath();
            this.ctx.arc(center.x, center.y, 20, 0, 2 * Math.PI, false);
            this.ctx.fillStyle = color;
            this.ctx.fill();
            this.ctx.lineWidth = 3;
            this.ctx.strokeStyle = color;
            this.ctx.stroke();
            
            const mathOverlay = document.getElementById('mathOverlay');
            const labelEl = document.createElement('div');
            labelEl.className = 'math-label';
            labelEl.style.left = `${center.x + 30}px`;
            labelEl.style.top = `${center.y - 20}px`;
            labelEl.innerText = label;
            mathOverlay.appendChild(labelEl);
            
            if (direction === 'in') {
                this.ctx.beginPath();
                this.ctx.moveTo(center.x - 10, center.y - 10);
                this.ctx.lineTo(center.x + 10, center.y + 10);
                this.ctx.moveTo(center.x + 10, center.y - 10);
                this.ctx.lineTo(center.x - 10, center.y + 10);
                this.ctx.strokeStyle = 'white';
                this.ctx.lineWidth = 3;
                this.ctx.stroke();
            } else { // out
                this.ctx.beginPath();
                this.ctx.arc(center.x, center.y, 5, 0, 2 * Math.PI, false);
                this.ctx.fillStyle = 'white';
                this.ctx.fill();
            }
        }
        
        draw() {
            this.canvas.width = this.canvas.offsetWidth;
            this.canvas.height = this.canvas.offsetHeight;
            this.drawGrid();
            
            document.getElementById('mathOverlay').innerHTML = '';
            
            const v1 = this.vectors[this.questionData.known1];
            const v2 = this.vectors[this.questionData.known2];
            
            if (v1.x === 0 && v1.y === 0) {
                this.drawCircularVector(this.questionData.known1, '#4299e1', `B`);
            } else {
                this.drawVector(v1, '#4299e1', `B`);
            }
            
            if (v2.x === 0 && v2.y === 0) {
                this.drawCircularVector(this.questionData.known2, '#10b981', `I`);
            } else {
                this.drawVector(v2, '#10b981', `I`);
            }
            
            // Draw user's selected answer if available
            if (this.selectedAnswer && this.selectedAnswer !== 'zero') {
                const userVector = this.vectors[this.selectedAnswer];
                if (userVector.x === 0 && userVector.y === 0) {
                    this.drawCircularVector(this.selectedAnswer, '#8b5cf6', 'F');
                } else {
                    this.drawVector(userVector, '#8b5cf6', 'F');
                }
            }
            
            // Draw correct answer on finish
            if (this.isAnswered) {
                if (this.questionData.correctAnswer === 'zero') {
                    const mathOverlay = document.getElementById('mathOverlay');
                    const labelEl = document.createElement('div');
                    labelEl.className = 'math-label force-correct';
                    labelEl.style.left = `${this.canvas.width / 2 - 30}px`;
                    labelEl.style.top = `${this.canvas.height / 2 - 15}px`;
                    labelEl.innerText = 'F = 0';
                    mathOverlay.appendChild(labelEl);
                } else {
                    const correctVector = this.vectors[this.questionData.correctAnswer];
                    if (correctVector.x === 0 && correctVector.y === 0) {
                        this.drawCircularVector(this.questionData.correctAnswer, '#dc2626', 'F');
                    } else {
                        this.drawVector(correctVector, '#dc2626', 'F');
                    }
                }
            }
        }
        
        generateQuestion() {
            const directions = ['up', 'down', 'left', 'right', 'in', 'out'];
            let known1 = directions[Math.floor(Math.random() * directions.length)];
            let known2 = directions[Math.floor(Math.random() * directions.length)];
            
            // Prevent same direction for both
            if (known1 === known2) {
                known2 = directions[(directions.indexOf(known2) + 1) % directions.length];
            }
            
            const v1 = this.vectors[known1];
            const v2 = this.vectors[known2];
            const crossProduct = v1.x * v2.y - v1.y * v2.x;
            let correctAnswer;

            // Check if parallel or anti-parallel
            const isParallel = v1.x * v2.y === v1.y * v2.x && v1.x * v2.x >= 0 && v1.y * v2.y >= 0;
            const isAntiParallel = v1.x * v2.y === v1.y * v2.x && v1.x * v2.x <= 0 && v1.y * v2.y <= 0;
            
            if (isParallel || isAntiParallel) {
                correctAnswer = 'zero';
            } else {
                let crossX = v1.y;
                let crossY = -v1.x;
                
                let dotProduct = crossX * v2.x + crossY * v2.y;
                if (dotProduct < 0) {
                    crossX = -crossX;
                    crossY = -crossY;
                }
                
                // Final vector is perpendicular to both
                let finalX = v2.y * (v1.x === 0 && v1.y === 0 ? 0 : (v1.x === 1 ? -1 : (v1.x === -1 ? 1 : 0))) - (v2.x === 0 && v2.y === 0 ? 0 : (v2.x === 1 ? -1 : (v2.x === -1 ? 1 : 0))) * v1.y;
                let finalY = (v2.x === 0 && v2.y === 0 ? 0 : (v2.x === 1 ? 1 : (v2.x === -1 ? -1 : 0))) * v1.x - v2.x * (v1.x === 0 && v1.y === 0 ? 0 : (v1.x === 1 ? 1 : (v1.x === -1 ? -1 : 0)));
                
                // Let's use a simpler approach based on fixed values
                // B(v1) x I(v2) = F(v3)
                // (x1, y1) x (x2, y2) = (x1y2 - y1x2)
                const v1_ = this.get3DVector(known1);
                const v2_ = this.get3DVector(known2);
                
                const crossX_ = v1_.y * v2_.z - v1_.z * v2_.y;
                const crossY_ = v1_.z * v2_.x - v1_.x * v2_.z;
                const crossZ_ = v1_.x * v2_.y - v1_.y * v2_.x;
                
                if (crossX_ === 0 && crossY_ === 0 && crossZ_ === 0) {
                    correctAnswer = 'zero';
                } else {
                    if (crossX_ === 1) correctAnswer = 'right';
                    else if (crossX_ === -1) correctAnswer = 'left';
                    else if (crossY_ === 1) correctAnswer = 'down';
                    else if (crossY_ === -1) correctAnswer = 'up';
                    else if (crossZ_ === 1) correctAnswer = 'out';
                    else if (crossZ_ === -1) correctAnswer = 'in';
                }
            }

            const unknownType = ['B', 'I', 'F'][Math.floor(Math.random() * 3)];
            let known1Type, known2Type, unknownLabel;

            if (unknownType === 'B') {
                known1Type = 'I';
                known2Type = 'F';
                unknownLabel = 'B';
                correctAnswer = this.getInverseVector(known2, known1);
            } else if (unknownType === 'I') {
                known1Type = 'B';
                known2Type = 'F';
                unknownLabel = 'I';
                correctAnswer = this.getInverseVector(known1, known2);
            } else { // F
                known1Type = 'B';
                known2Type = 'I';
                unknownLabel = 'F';
                correctAnswer = this.getCrossProductVector(known1, known2);
            }
            
            // Randomize order of knowns
            if (Math.random() > 0.5) {
                [known1, known2] = [known2, known1];
                [known1Type, known2Type] = [known2Type, known1Type];
            }

            this.questionData = {
                known1: known1,
                known2: known2,
                correctAnswer: correctAnswer,
                unknownLabel: unknownLabel,
                known1Type: known1Type,
                known2Type: known2Type
            };
            
            document.getElementById('questionTitle').innerText = `Câu ${this.total + 1}: Tìm đại lượng chưa biết`;
            document.getElementById('known1').innerHTML = `\\($\\vec{${known1Type}}$ = ${this.vectorLabels[known1]}\\)`;
            document.getElementById('known2').innerHTML = `\\($\\vec{${known2Type}}$ = ${this.vectorLabels[known2]}\\)`;
            document.getElementById('unknown').innerHTML = `\\(Cần tìm: \\vec{${unknownLabel}}\\)`;
            
            // Re-render MathJax
            MathJax.typeset();
            
            this.draw();
        }
        
        get3DVector(direction) {
            switch(direction) {
                case 'up': return {x: 0, y: -1, z: 0};
                case 'down': return {x: 0, y: 1, z: 0};
                case 'left': return {x: -1, y: 0, z: 0};
                case 'right': return {x: 1, y: 0, z: 0};
                case 'in': return {x: 0, y: 0, z: -1};
                case 'out': return {x: 0, y: 0, z: 1};
                default: return {x: 0, y: 0, z: 0};
            }
        }
        
        getVectorFrom3D(vector) {
            if (vector.x === 1) return 'right';
            if (vector.x === -1) return 'left';
            if (vector.y === 1) return 'down';
            if (vector.y === -1) return 'up';
            if (vector.z === 1) return 'out';
            if (vector.z === -1) return 'in';
            return 'zero';
        }
        
        getCrossProductVector(v1Dir, v2Dir) {
            const v1 = this.get3DVector(v1Dir);
            const v2 = this.get3DVector(v2Dir);
            
            const crossX = v1.y * v2.z - v1.z * v2.y;
            const crossY = v1.z * v2.x - v1.x * v2.z;
            const crossZ = v1.x * v2.y - v1.y * v2.x;
            
            const resultVector = {x: crossX, y: crossY, z: crossZ};
            return this.getVectorFrom3D(resultVector);
        }
        
        getInverseVector(v1Dir, v2Dir) {
            // Find v3 so that v1 x v3 = v2
            const v1 = this.get3DVector(v1Dir);
            const v2 = this.get3DVector(v2Dir);
            
            const x = v1.y * v2.z - v1.z * v2.y;
            const y = v1.z * v2.x - v1.x * v2.z;
            const z = v1.x * v2.y - v1.y * v2.x;
            
            const resultVector = {x: x, y: y, z: z};
            return this.getVectorFrom3D(resultVector);
        }

        checkAnswer() {
            if (this.isAnswered) return;
            this.isAnswered = true;
            document.getElementById('checkBtn').disabled = true;
            
            const isCorrect = this.selectedAnswer === this.questionData.correctAnswer;
            
            if (isCorrect) {
                this.correct++;
                document.getElementById('popupIcon').innerText = '🎉';
                document.getElementById('popupTitle').innerText = 'Chính xác!';
                document.getElementById('popupDesc').innerText = 'Bạn đã áp dụng đúng quy tắc bàn tay trái!';
                document.getElementById('popupScore').innerText = `+1 điểm`;
                showMessage('correct', '✅ Đáp án chính xác!');
            } else {
                document.getElementById('popupIcon').innerText = '🤔';
                document.getElementById('popupTitle').innerText = 'Chưa chính xác!';
                document.getElementById('popupDesc').innerText = `Đáp án đúng là: ${this.vectorLabels[this.questionData.correctAnswer]}`;
                document.getElementById('popupScore').innerText = `+0 điểm`;
                showMessage('incorrect', `❌ Đáp án sai. Đáp án đúng là: ${this.vectorLabels[this.questionData.correctAnswer]}`);
            }
            
            this.total++;
            this.updateScore();
            this.draw();
            showPopup('resultPopup');
            statsManager.trackQuestion(isCorrect);
            
            const userKey = `${studentName}_${studentClass}`;
            if (statsManager.stats.userSessions[userKey]) {
                statsManager.stats.userSessions[userKey].totalTime += this.getElapsedTime();
                if (this.score > statsManager.stats.userSessions[userKey].bestScore) {
                    statsManager.stats.userSessions[userKey].bestScore = this.score;
                }
            }
            statsManager.saveStats();
        }
        
        newQuestion() {
            this.isAnswered = false;
            this.selectedAnswer = '';
            this.generateQuestion();
            this.resetPalette();
            document.getElementById('checkBtn').disabled = false;
            document.getElementById('message').innerHTML = '';
            document.getElementById('message').style.display = 'none';
        }

        updateScore() {
            document.getElementById('score').innerText = this.correct;
            document.getElementById('total').innerText = this.total;
            if (this.total > 0) {
                const accuracy = (this.correct / this.total * 100).toFixed(1);
                document.getElementById('accuracy').innerText = `${accuracy}%`;
            } else {
                document.getElementById('accuracy').innerText = '0%';
            }
            this.score = this.correct;
        }

        resetPalette() {
            const options = document.querySelectorAll('.answer-option');
            options.forEach(option => option.classList.remove('selected'));
        }
    }

    // Global Functions
    function startGame(event) {
        event.preventDefault();
        studentName = document.getElementById('studentName').value;
        studentClass = document.getElementById('studentClass').value;
        
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('gamePage').style.display = 'block';
        document.getElementById('statsToggle').style.display = 'block';
        
        game = new Game();
        document.getElementById('playerInfo').innerText = `Tên: ${studentName} - Lớp: ${studentClass}`;
        
        statsManager = new StatisticsManager();
        statsManager.trackUser(studentName, studentClass);
        statsManager.trackGameStart();
        
        window.onresize = () => game.draw();
    }
    
    function finishExam() {
        if (!game) return;
        game.stopTimer();
        
        const totalTime = game.getElapsedTime();
        const sessionData = {
            name: studentName,
            studentClass: studentClass,
            date: new Date().toLocaleDateString('vi-VN'),
            accessCount: 1, // Placeholder
            totalQuestions: game.total,
            correctAnswers: game.correct,
            wrongAnswers: game.total - game.correct,
            accuracy: game.total > 0 ? (game.correct / game.total * 100).toFixed(1) : 0,
            score10: game.total > 0 ? (game.correct / game.total * 10).toFixed(1) : 0,
            score100: game.total > 0 ? (game.correct / game.total * 100).toFixed(1) : 0,
            timeSpent: formatTime(totalTime)
        };
        
        statsManager.addSessionToSheet(sessionData);

        document.getElementById('finalTotal').innerText = game.total;
        document.getElementById('finalCorrect').innerText = game.correct;
        document.getElementById('finalAccuracy').innerText = game.total > 0 ? (game.correct / game.total * 100).toFixed(1) + '%' : '0%';
        document.getElementById('finalTime').innerText = formatTime(totalTime);
        document.getElementById('finalResultsStudent').innerText = `Học sinh: ${studentName}`;
        
        const accuracy = game.total > 0 ? game.correct / game.total : 0;
        const finalMessageEl = document.getElementById('finalMessage');
        if (accuracy >= 0.8) {
            finalMessageEl.innerText = '🎉 Chúc mừng! Bạn đã hoàn thành xuất sắc!';
            finalMessageEl.className = 'final-message excellent';
        } else if (accuracy >= 0.5) {
            finalMessageEl.innerText = '💪 Khá tốt! Cần cố gắng hơn nữa.';
            finalMessageEl.className = 'final-message good';
        } else {
            finalMessageEl.innerText = '📝 Cần ôn tập thêm! Đừng nản chí!';
            finalMessageEl.className = 'final-message needs-improvement';
        }
        
        showPopup('finalResultsPopup');
    }
    
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
    
    function resetGame() {
        if (confirm('Bạn có chắc muốn đặt lại toàn bộ?')) {
            location.reload();
        }
    }
    
    function restartGame() {
        closePopup('finalResultsPopup');
        game.correct = 0;
        game.total = 0;
        game.score = 0;
        game.updateScore();
        game.newQuestion();
        game.startTimer();
    }

    function selectAnswer(answer) {
        if (game.isAnswered) return;
        game.resetPalette();
        const selectedEl = document.querySelector(`.answer-option[onclick="selectAnswer('${answer}')"]`);
        selectedEl.classList.add('selected');
        game.selectedAnswer = answer;
    }

    function checkAnswer() {
        game.checkAnswer();
    }
    
    function newQuestion() {
        game.newQuestion();
    }
    
    function showMessage(type, text) {
        const messageEl = document.getElementById('message');
        messageEl.style.display = 'block';
        messageEl.className = `message ${type}`;
        messageEl.innerText = text;
    }
    
    function showPopup(id) {
        document.getElementById(id).classList.add('show');
    }
    
    function closePopup(id) {
        document.getElementById(id).classList.remove('show');
    }
    
    function toggleStats() {
        const statsPanel = document.getElementById('statsPanel');
        const statsToggle = document.getElementById('statsToggle');
        statsPanel.classList.toggle('hidden');
        if (statsPanel.classList.contains('hidden')) {
            statsToggle.innerText = '📊';
        } else {
            statsToggle.innerText = '❌';
        }
    }
    
    async function showStudentStats() {
        const statsTableBody = document.getElementById('statsTableBody');
        statsTableBody.innerHTML = '<tr><td colspan="11">Đang tải dữ liệu...</td></tr>';
        
        const sessions = await statsManager.getStudentSessions();
        statsTableBody.innerHTML = '';
        
        if (sessions.length > 0) {
            let stt = 1;
            sessions.forEach(session => {
                const row = document.createElement('tr');
                const accuracyClass = session.accuracy >= 80 ? 'score-excellent' : (session.accuracy >= 50 ? 'score-good' : 'score-needs-improvement');
                row.innerHTML = `
                    <td>${stt++}</td>
                    <td>${session.name}</td>
                    <td>${session.studentClass}</td>
                    <td>${session.date}</td>
                    <td>${session.accessCount}</td>
                    <td>${session.totalQuestions}</td>
                    <td>${session.correctAnswers}</td>
                    <td>${session.wrongAnswers}</td>
                    <td class="${accuracyClass}">${session.accuracy}%</td>
                    <td>${session.score10}</td>
                    <td>${session.score100}</td>
                `;
                statsTableBody.appendChild(row);
            });
        } else {
            statsTableBody.innerHTML = '<tr><td colspan="11">Không có dữ liệu thống kê nào được tìm thấy.</td></tr>';
        }
        
        const now = new Date();
        const month = now.toLocaleString('vi-VN', { month: 'long', year: 'numeric' });
        document.getElementById('currentMonth').innerText = month;
        showPopup('studentStatsPopup');
    }

    function closeStudentStats() {
        closePopup('studentStatsPopup');
    }
    
    function exportCSV() {
        // This function would be implemented to fetch data and create a CSV file
        alert("Tính năng xuất CSV đang được phát triển.");
    }

</script>
</body>
</html>